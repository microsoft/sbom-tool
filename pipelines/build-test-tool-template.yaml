steps:
  - task: UseDotNet@2
    displayName: 'Use .NET Core'
    inputs:
      useGlobalJson: true

  - pwsh: dotnet restore --configfile nuget.config
    displayName: 'Restore solution'

  - pwsh: dotnet build --configuration $(BuildConfiguration) --no-restore
    displayName: Build

  - pwsh: dotnet test --no-build --configuration $(BuildConfiguration) -- --report-trx --results-directory $(Agent.TempDirectory) --coverage --coverage-output $(Agent.TempDirectory)/coverage.cobertura.xml --coverage-output-format cobertura
    displayName: Run unit tests (with coverage on Windows)
    condition: eq(variables['Agent.OS'], 'Windows_NT')

  - pwsh: dotnet test --no-build --configuration $(BuildConfiguration) -- --report-trx --results-directory $(Agent.TempDirectory)
    displayName: Run unit tests (without coverage on non-Windows)
    condition: ne(variables['Agent.OS'], 'Windows_NT')

  # While DotNetCoreCLI docs say that it publishes both TRX and coverage, it doesn't actually publish coverage.
  # https://github.com/microsoft/azure-pipelines-tasks/issues/18254
  # https://github.com/microsoft/azure-pipelines-tasks/blob/32b9a3224f25403218dd995eec248f64025f3e2e/Tasks/DotNetCoreCLIV2/dotnetcore.ts#L196-L208
  - task: PublishCodeCoverageResults@2
    displayName: "Publish code coverage (Windows only)"
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    inputs:
      summaryFileLocation: '$(Agent.TempDirectory)/coverage.cobertura.xml'